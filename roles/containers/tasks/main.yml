---  
- name: "Create the private Docker network"
  docker_network:
    name: "{{ private_network.name }}"
    ipam_config:
      - subnet: "{{ private_network.subnet }}"
        gateway: "{{ private_network.gateway }}"

- name: "[CONTAINER 1] Building image"
  docker_image:
    name: ctf-c1-debian12
    tag: "1.0"
    source: build
    build:
      path: "{{ role_path }}/files/container1"
    force_source: yes
  tags: "c1"

- name: "[CONTAINER 2] Building image"
  docker_image:
    name: ctf-c2-debian12
    tag: "1.0"
    source: build
    build:
      path: "{{ role_path }}/files/container2"
    force_source: yes
  tags: "c2"

- name: "[CONTAINER 1] Resetting"
  community.docker.docker_container:
    name: "{{ container1.name }}"
    state: absent
    force_kill: true
    keep_volumes: false
  tags: ["reset_c1", "reset_all", "c1"]

- name: "[CONTAINER 2] Resetting"
  community.docker.docker_container:
    name: "{{ container2.name }}"
    state: absent
    force_kill: true
    keep_volumes: false
  tags: ["reset_c2", "reset_all", "c2"]

- name: "[CONTAINER 1] Starting"
  docker_container:
    name: "{{ container1.name }}"
    hostname: "dollex_infra"
    image: "ctf-c1-debian12:1.0"
    state: started
    recreate: yes
    privileged: true
    restart_policy: unless-stopped
    capabilities:
      - NET_ADMIN
    sysctls:
      net.ipv4.ip_forward: "1"
      net.ipv4.conf.all.rp_filter: "0"
      net.ipv4.conf.default.rp_filter: "0"
    networks:
      - name: "{{ lab_network.name }}"
        ipv4_address: "{{ container1.lab_ip }}"
      - name: "{{ private_network.name }}"
        ipv4_address: "{{ container1.private_ip }}"
  tags: ["reset_c1", "reset_all", "c1"]


- name: "[CONTAINER 2] Starting"
  docker_container:
    name: "{{ container2.name }}"
    hostname: "doghouse"
    image: "ctf-c2-debian12:1.0"
    state: started
    recreate: yes
    restart_policy: unless-stopped
    privileged: true
    capabilities:
      - NET_ADMIN
    networks:
      - name: "{{ private_network.name }}"
        ipv4_address: "{{ container2.private_ip }}"
  tags: ["reset_c2", "reset_all", "c2"]

- name: "[CONTAINER 2] Route to the VPN via the bastion"
  ansible.builtin.command: >
    docker exec {{ container2.name }} sh -c "
      ip route replace 10.8.0.0/24 via {{ container1.private_ip }}
    "
  changed_when: false
  tags: ["reset_c2", "reset_all", "c2"]

- name: "Wait for docker exec to work in the bastion container"
  ansible.builtin.command: docker exec {{ container1.name }} sh -c "echo -n ready"
  register: exec_test
  until: exec_test.rc == 0
  retries: 25
  delay: 2
  changed_when: false
  tags: ["reset_c1", "reset_all", "c1"]

- name: "[CONTAINER 1] One-way firewall (VPN->private blocked, returns allowed) + private SNAT->VPN"
  ansible.builtin.command: >
    docker exec {{ container1.name }} sh -c "
      iptables -C OUTPUT -d {{ private_network.gateway }} -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT 2>/dev/null ||
      iptables -I OUTPUT 1 -d {{ private_network.gateway }} -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT;

      iptables -C OUTPUT -d {{ private_network.gateway }} -j DROP 2>/dev/null ||
      iptables -I OUTPUT 2 -d {{ private_network.gateway }} -j DROP;

      # 1) Authorise private -> VPN
      iptables -C FORWARD -s {{ private_network.subnet }} -d 10.8.0.0/24 -j ACCEPT 2>/dev/null ||
      iptables -A FORWARD -s {{ private_network.subnet }} -d 10.8.0.0/24 -j ACCEPT;

      # 2) Authorise VPN -> private only in ESTABLISHED/RELATED
      iptables -C FORWARD -s 10.8.0.0/24 -d {{ private_network.subnet }} -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 2>/dev/null ||
      iptables -A FORWARD -s 10.8.0.0/24 -d {{ private_network.subnet }} -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT;

      # 3) Block VPN -> private
      iptables -C FORWARD -s 10.8.0.0/24 -d {{ private_network.subnet }} -j DROP 2>/dev/null ||
      iptables -A FORWARD -s 10.8.0.0/24 -d {{ private_network.subnet }} -j DROP;

      # 4) Private SNAT -> VPN to not expose 172.16.20.0/24 to players
      iptables -t nat -C POSTROUTING -s {{ private_network.subnet }} -d 10.8.0.0/24 -j SNAT --to-source {{ container1.lab_ip }} 2>/dev/null ||
      iptables -t nat -A POSTROUTING -s {{ private_network.subnet }} -d 10.8.0.0/24 -j SNAT --to-source {{ container1.lab_ip }}
    "
  changed_when: false
  tags: ["reset_c1", "reset_all", "c1"]

